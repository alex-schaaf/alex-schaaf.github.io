<!doctype html>
<html lang="en">

<head>
  <title>Automate parsing Kindle highlights using Go</title>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Roboto&family=Roboto+Mono&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <header>
    <nav>
      <a href="/" class="title">
        Alexander Schaaf
      </a>
    </nav>
  </header>
  <main>
    <div class="post">
  <div>
    <h1 class="title">
      Automate parsing Kindle highlights using Go
    </h1>
    <span class="date">February 14, 2020</span>
  </div>
  <div>
    <p>Syncing highlights from my Kindle without relying on Amazon’s <a href="https://www.theverge.com/2020/1/31/21117217/amazon-kindle-tracking-page-turn-taps-e-reader-privacy-policy-security-whispersync">Whispersync</a> involves copying your clippings file from the Kindle, either using tools such as <a href="https://calibre-ebook.com/">Calibre</a>, or manually. And the Kindle just dumps all highlights into one file - which is great if you just want to search over all your highlights. But I find myself often just wanting to conveniently look at my highlights from single book.</p>
<p>So as an exercise in further learning Go I decided to write a little program that can be easily executed whenever I connect my kindle. An advantage of using a compiled language like Go is that provides us with a nice binary program we can compile for any common platflorm and easily automate it to run whenever we connect a Kindle - without having to manage Python environments.</p>
<p>So let’s start out with our <code>main</code> function and load open the clippings text file from the connected Kindle device. You may have to modify the path depending on your device and operating system.</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">package</span> main<br><br><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"/Volumes/Kindle/documents/My Clippings.txt"</span><span class="token punctuation">)</span><br>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br>    file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre>
<p>We can now use a <a href="https://medium.com/golangspec/in-depth-introduction-to-bufio-scanner-in-golang-55483bb689b4">Scanner</a> from Go’s <code>bufio</code> package, and use it’s <code>Split</code> read the file line by line. We can iterate to the next line by calling <code>scanner.Scan()</code> and access the line’s text using <code>scanner.Text()</code>.</p>
<pre class="language-go"><code class="language-go"><span class="highlight-line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"/Volumes/Kindle/documents/My Clippings.txt"</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span><br><span class="highlight-line">	<span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><mark class="highlight-line highlight-line-active">    scanner <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewScanner</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span></mark><br><mark class="highlight-line highlight-line-active">    scanner<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>bufio<span class="token punctuation">.</span>ScanLines<span class="token punctuation">)</span></mark><br><mark class="highlight-line highlight-line-active"></mark><br><mark class="highlight-line highlight-line-active">    <span class="token keyword">for</span> scanner<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">        line <span class="token operator">:=</span> scanner<span class="token punctuation">.</span><span class="token function">Text</span><span class="token punctuation">(</span><span class="token punctuation">)</span></mark><br><mark class="highlight-line highlight-line-active">        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token punctuation">}</span></mark><br><span class="highlight-line">    file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span><br><span class="highlight-line"></span></code></pre>
<p>So now that we have access to every line in the file, we can have a look at the structure of the text file to figure out how to parse it. Here are two highlights:</p>
<pre class="language-text"><code class="language-text">The Color of Magic (Terry David John Pratchett)<br>- Your Highlight at location 2-3 | Added on Sunday, 14 February 2021 09:24:24<br><br>The Colour of Magic is Terry Pratchett’s maiden voyage through the bizarre land of Discworld.<br>==========<br>The Color of Magic (Terry David John Pratchett)<br>- Your Highlight at location 4-5 | Added on Sunday, 14 February 2021 09:32:41<br><br>“All wizards get like that… it’s the quicksilver fumes. Rots their brains. Mushrooms, too.”<br>==========</code></pre>
<p>The individual highlights are separated by <code>==========</code>. Each first line of a highlight contains the book title and author. In the second line we find the highlight’s location and when it was created. The actual highlight comes afterwards.</p>
<p>So, naturally we want to save all this info. We could use a <code>map</code> as a data structure for the highlights, but a simple data <code>struct</code> can handles much more intuitively and with autocompletion:</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">type</span> HighlightData <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>	Author    <span class="token builtin">string</span><br>	Book      <span class="token builtin">string</span><br>	Timestamp <span class="token builtin">string</span><br>	Location  <span class="token builtin">string</span><br>	Text      <span class="token builtin">string</span><br><span class="token punctuation">}</span></code></pre>
<p>We also define a constant for the separator:</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">const</span> separator <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">"=========="</span></code></pre>
<p>Now, for the parsing we always want to know the current line, but not of the humongous <code>My Clippings.txt</code> file itself, but within each highlight. That way we can easily determine where the metadata is located. We can use a simple counter variable to keep track of the line we are in within each individual highlight. When we reach a seperator line, we reset the counter to zero, otherwise we increment:</p>
<pre class="language-go"><code class="language-go"><span class="highlight-line">    <span class="token comment">// ...</span></span><br><span class="highlight-line">    <span class="token keyword">var</span> counter <span class="token builtin">int</span></span><br><span class="highlight-line">    <span class="token keyword">for</span> scanner<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        line <span class="token operator">:=</span> scanner<span class="token punctuation">.</span><span class="token function">Text</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line">        </span><br><mark class="highlight-line highlight-line-active">        <span class="token keyword">if</span> line <span class="token operator">==</span> separator <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">            counter <span class="token operator">=</span> <span class="token number">0</span></mark><br><mark class="highlight-line highlight-line-active">            <span class="token keyword">continue</span></mark><br><mark class="highlight-line highlight-line-active">        <span class="token punctuation">}</span></mark><br><mark class="highlight-line highlight-line-active">        counter<span class="token operator">++</span></mark><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">    file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></code></pre>
<h2 id="parsing-author-and-book-title">Parsing author and book title <a class="direct-link" href="#parsing-author-and-book-title">#</a></h2>
<p>Alright, next up is parsing the first line of each highlight: book title and author. The function <code>parseAuthorTitle</code> takes in the target line as a string, splits it at the opening parenthesis into book title and author. We then just need to trim the spaces and trailing parenthesis off, and return the two strings.</p>
<pre class="language-go"><code class="language-go"><span class="token comment">// example line:</span><br><span class="token comment">// The Color of Magic (Terry David John Pratchett)</span><br><span class="token keyword">func</span> <span class="token function">parseAuthorTitle</span><span class="token punctuation">(</span>line <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	splitLines <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">"("</span><span class="token punctuation">)</span><br>	bookRaw <span class="token operator">:=</span> splitLines<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><br>	authorRaw <span class="token operator">:=</span> splitLines<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><br><br>	book <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">TrimSpace</span><span class="token punctuation">(</span>bookRaw<span class="token punctuation">)</span><br>	author <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Trim</span><span class="token punctuation">(</span>authorRaw<span class="token punctuation">,</span> <span class="token string">")"</span><span class="token punctuation">)</span><br>	<span class="token keyword">return</span> author<span class="token punctuation">,</span> book<br><span class="token punctuation">}</span></code></pre>
<p>Okay, now that we have our first part of parsed data and our data structure defined, we need a convenient way of saving it. For that we create an empty slice to append our highlights to (<code>var highlights []HighlightData</code>) and instantiate our first empty highlight <code>var highlight HighlightData = HighlightData{}</code>, which we will fill with our first clipping. Once we’ve parsed all lines of the first highlight, we’ll hit a separator. We then append the current highlight object to our slice of highlights and overwrite our <code>highlight</code> variable with a new empty <code>HighlightData</code> object which we can fill with the next highlight.</p>
<pre class="language-go"><code class="language-go"><span class="highlight-line">    <span class="token comment">// ...</span></span><br><span class="highlight-line">    <span class="token keyword">var</span> counter <span class="token builtin">int</span></span><br><span class="highlight-line"></span><br><mark class="highlight-line highlight-line-active">    <span class="token keyword">var</span> highlights <span class="token punctuation">[</span><span class="token punctuation">]</span>HighlightData</mark><br><mark class="highlight-line highlight-line-active">    <span class="token keyword">var</span> hl HighlightData <span class="token operator">=</span> highlight<span class="token punctuation">{</span><span class="token punctuation">}</span></mark><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token keyword">for</span> scanner<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        line <span class="token operator">:=</span> scanner<span class="token punctuation">.</span><span class="token function">Text</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><mark class="highlight-line highlight-line-active">        <span class="token keyword">if</span> counter <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">            hl<span class="token punctuation">.</span>author<span class="token punctuation">,</span> hl<span class="token punctuation">.</span>book <span class="token operator">=</span> <span class="token function">parseAuthorTitle</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span></mark><br><mark class="highlight-line highlight-line-active">        <span class="token punctuation">}</span></mark><br><span class="highlight-line">        </span><br><span class="highlight-line">        <span class="token keyword">if</span> line <span class="token operator">==</span> separator <span class="token punctuation">{</span></span><br><mark class="highlight-line highlight-line-active">            highlights <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>highlights<span class="token punctuation">,</span> hl<span class="token punctuation">)</span></mark><br><mark class="highlight-line highlight-line-active">			hl <span class="token operator">=</span> HighlightData<span class="token punctuation">{</span><span class="token punctuation">}</span></mark><br><span class="highlight-line">            counter <span class="token operator">=</span> <span class="token number">0</span></span><br><span class="highlight-line">            <span class="token keyword">continue</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span></span><br><span class="highlight-line">        counter<span class="token operator">++</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">    file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></code></pre>
<h2 id="parsing-location-and-timestamp">Parsing location and timestamp <a class="direct-link" href="#parsing-location-and-timestamp">#</a></h2>
<p>Next up is the second line in each highlight, containing its book location and timestamp. So we create a new function called <code>parseLocDatetime</code>, which also takes the line as an input and outputs the location and timestamp as strings. We split the line at the pipe <code>|</code> into the location on the left and timestamp on the right.</p>
<p>We then use a regular expression to extract just the location numbers. <code>[\d]+-[\d]+</code> will do just fine for that. For the timestamp, we can just remove the <code>Added on </code> and be done with it. If you want to actually parse the timestamp string into a timestamp-like object, this would be the place to do it. But I’m fine with the timestamp as it is.</p>
<pre class="language-go"><code class="language-go"><span class="token comment">// example line</span><br><span class="token comment">// - Your Highlight at location 2-3 | Added on Sunday, 14 February 2021 09:24:24</span><br><span class="token keyword">func</span> <span class="token function">parseLocDatetime</span><span class="token punctuation">(</span>line <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	header <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">" | "</span><span class="token punctuation">)</span><br>	locRaw <span class="token operator">:=</span> header<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><br>	re <span class="token operator">:=</span> regexp<span class="token punctuation">.</span><span class="token function">MustCompile</span><span class="token punctuation">(</span><span class="token string">`[\d]+-[\d]+`</span><span class="token punctuation">)</span><br>	locRange <span class="token operator">:=</span> re<span class="token punctuation">.</span><span class="token function">FindString</span><span class="token punctuation">(</span>locRaw<span class="token punctuation">)</span><br><br>	location <span class="token operator">:=</span> locRange<br><br>	dateRaw <span class="token operator">:=</span> header<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><br>	timestamp <span class="token operator">:=</span> dateRaw<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token punctuation">]</span><br>	<span class="token keyword">return</span> location<span class="token punctuation">,</span> timestamp<br><span class="token punctuation">}</span></code></pre>
<p>Adding the function call to our parsing loop, only triggering it in the second line of each clipping:</p>
<pre class="language-go"><code class="language-go"><span class="highlight-line">    <span class="token comment">// ...</span></span><br><span class="highlight-line">    <span class="token keyword">var</span> counter <span class="token builtin">int</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token keyword">var</span> highlights <span class="token punctuation">[</span><span class="token punctuation">]</span>HighlightData</span><br><span class="highlight-line">    <span class="token keyword">var</span> hl HighlightData <span class="token operator">=</span> highlight<span class="token punctuation">{</span><span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token keyword">for</span> scanner<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        line <span class="token operator">:=</span> scanner<span class="token punctuation">.</span><span class="token function">Text</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">        <span class="token keyword">if</span> counter <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">            hl<span class="token punctuation">.</span>author<span class="token punctuation">,</span> hl<span class="token punctuation">.</span>book <span class="token operator">=</span> <span class="token function">parseAuthorTitle</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span></span><br><mark class="highlight-line highlight-line-active">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> counter <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">            hl<span class="token punctuation">.</span>location<span class="token punctuation">,</span> hl<span class="token punctuation">.</span>timestamp <span class="token operator">=</span> <span class="token function">parseLocDatetime</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span></mark><br><mark class="highlight-line highlight-line-active">        <span class="token punctuation">}</span></mark><br><span class="highlight-line">        </span><br><span class="highlight-line">        <span class="token keyword">if</span> line <span class="token operator">==</span> separator <span class="token punctuation">{</span></span><br><span class="highlight-line">            highlights <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>highlights<span class="token punctuation">,</span> hl<span class="token punctuation">)</span></span><br><span class="highlight-line">			hl <span class="token operator">=</span> HighlightData<span class="token punctuation">{</span><span class="token punctuation">}</span></span><br><span class="highlight-line">            counter <span class="token operator">=</span> <span class="token number">0</span></span><br><span class="highlight-line">            <span class="token keyword">continue</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span></span><br><span class="highlight-line">        counter<span class="token operator">++</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">    file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></code></pre>
<p>Next up is the actually highlighted text - which is much simpler to parse, as we just need to append each text line to our <code>highlight.Text</code> property. We can do that in the <code>else</code> block:</p>
<pre class="language-go"><code class="language-go"><span class="highlight-line">    <span class="token comment">// ...</span></span><br><span class="highlight-line">    <span class="token keyword">var</span> counter <span class="token builtin">int</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token keyword">var</span> highlights <span class="token punctuation">[</span><span class="token punctuation">]</span>HighlightData</span><br><span class="highlight-line">    <span class="token keyword">var</span> hl HighlightData <span class="token operator">=</span> HighlightData<span class="token punctuation">{</span><span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token keyword">for</span> scanner<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        line <span class="token operator">:=</span> scanner<span class="token punctuation">.</span><span class="token function">Text</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">        <span class="token keyword">if</span> counter <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">            hl<span class="token punctuation">.</span>author<span class="token punctuation">,</span> hl<span class="token punctuation">.</span>book <span class="token operator">=</span> <span class="token function">parseAuthorTitle</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> counter <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">            hl<span class="token punctuation">.</span>location<span class="token punctuation">,</span> hl<span class="token punctuation">.</span>timestamp <span class="token operator">=</span> <span class="token function">parseLocDatetime</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span></span><br><mark class="highlight-line highlight-line-active">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></mark><br><span class="highlight-line">            <span class="token keyword">if</span> line <span class="token operator">==</span> separator <span class="token punctuation">{</span></span><br><span class="highlight-line">                highlights <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>highlights<span class="token punctuation">,</span> hl<span class="token punctuation">)</span></span><br><span class="highlight-line">			    hl <span class="token operator">=</span> HighlightData<span class="token punctuation">{</span><span class="token punctuation">}</span></span><br><span class="highlight-line">                counter <span class="token operator">=</span> <span class="token number">0</span></span><br><span class="highlight-line">                <span class="token keyword">continue</span></span><br><span class="highlight-line">            <span class="token punctuation">}</span></span><br><mark class="highlight-line highlight-line-active">            hl<span class="token punctuation">.</span>text <span class="token operator">=</span> hl<span class="token punctuation">.</span>text <span class="token operator">+</span> line</mark><br><span class="highlight-line">        <span class="token punctuation">}</span></span><br><span class="highlight-line">        counter<span class="token operator">++</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">    file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></code></pre>
<p>Note that for this to work properly, we have to first check if the line is a separator, as we really don’t want that in our highlight text. So we move the code checking for the separator into the <code>else</code> block in front of where we append the text.</p>
<p>And with that we’re all done with the actual parsing code. But what’s missing is saving it to disk in convenient file structure.</p>
<h2 id="saving-it-all-to-disk">Saving it all to disk <a class="direct-link" href="#saving-it-all-to-disk">#</a></h2>
<p>I want my clippings to be stored on my NAS server in a <code>kindle-clippings</code> folder, with a folder for each author and a markdown file for each book. For that let’s code up a <code>saveHighlight</code> function that takes as arguments the highlight to save, and the clippings root folder.</p>
<p>As a first step, we check if the folder exists - and create it if not:</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">saveHighlight</span><span class="token punctuation">(</span>hl HighlightData<span class="token punctuation">,</span> loc <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span>loc<span class="token punctuation">)</span><span class="token punctuation">;</span> os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		os<span class="token punctuation">.</span><span class="token function">Mkdir</span><span class="token punctuation">(</span>loc<span class="token punctuation">,</span> os<span class="token punctuation">.</span>ModePerm<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>Then we do the same thing with the author folder:</p>
<pre class="language-go"><code class="language-go"><span class="highlight-line"><span class="token keyword">func</span> <span class="token function">saveHighlight</span><span class="token punctuation">(</span>hl HighlightData<span class="token punctuation">,</span> loc <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span>loc<span class="token punctuation">)</span><span class="token punctuation">;</span> os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">		os<span class="token punctuation">.</span><span class="token function">Mkdir</span><span class="token punctuation">(</span>loc<span class="token punctuation">,</span> os<span class="token punctuation">.</span>ModePerm<span class="token punctuation">)</span></span><br><span class="highlight-line">	<span class="token punctuation">}</span></span><br><mark class="highlight-line highlight-line-active"></mark><br><mark class="highlight-line highlight-line-active">    authorFolder <span class="token operator">:=</span> highlightsFolder <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> highlight<span class="token punctuation">.</span>Author</mark><br><mark class="highlight-line highlight-line-active">	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span>authorFolder<span class="token punctuation">)</span><span class="token punctuation">;</span> os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">		os<span class="token punctuation">.</span><span class="token function">Mkdir</span><span class="token punctuation">(</span>authorFolder<span class="token punctuation">,</span> os<span class="token punctuation">.</span>ModePerm<span class="token punctuation">)</span></mark><br><mark class="highlight-line highlight-line-active">	<span class="token punctuation">}</span></mark><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p>And then check if the book file exists. If not we create it with both the book title and author at the top:</p>
<pre class="language-go"><code class="language-go"><span class="highlight-line"><span class="token keyword">func</span> <span class="token function">saveHighlight</span><span class="token punctuation">(</span>hl HighlightData<span class="token punctuation">,</span> loc <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span>loc<span class="token punctuation">)</span><span class="token punctuation">;</span> os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">		os<span class="token punctuation">.</span><span class="token function">Mkdir</span><span class="token punctuation">(</span>loc<span class="token punctuation">,</span> os<span class="token punctuation">.</span>ModePerm<span class="token punctuation">)</span></span><br><span class="highlight-line">	<span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    authorFolder <span class="token operator">:=</span> highlightsFolder <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> highlight<span class="token punctuation">.</span>Author</span><br><span class="highlight-line">	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span>authorFolder<span class="token punctuation">)</span><span class="token punctuation">;</span> os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">		os<span class="token punctuation">.</span><span class="token function">Mkdir</span><span class="token punctuation">(</span>authorFolder<span class="token punctuation">,</span> os<span class="token punctuation">.</span>ModePerm<span class="token punctuation">)</span></span><br><span class="highlight-line">	<span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><mark class="highlight-line highlight-line-active">    bookFile <span class="token operator">:=</span> authorFolder <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> highlight<span class="token punctuation">.</span>Book <span class="token operator">+</span> <span class="token string">".md"</span></mark><br><mark class="highlight-line highlight-line-active">	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span>bookFile<span class="token punctuation">)</span><span class="token punctuation">;</span> os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">		err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span></mark><br><mark class="highlight-line highlight-line-active">            bookFile<span class="token punctuation">,</span> </mark><br><mark class="highlight-line highlight-line-active">            <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"# "</span><span class="token operator">+</span>highlight<span class="token punctuation">.</span>Book<span class="token operator">+</span><span class="token string">"\n## "</span><span class="token operator">+</span>highlight<span class="token punctuation">.</span>Author<span class="token punctuation">)</span><span class="token punctuation">,</span> </mark><br><mark class="highlight-line highlight-line-active">            <span class="token number">0755</span><span class="token punctuation">)</span> <span class="token comment">// unix file permissions code</span></mark><br><mark class="highlight-line highlight-line-active">		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">			log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>er<span class="token punctuation">)</span></mark><br><mark class="highlight-line highlight-line-active">		<span class="token punctuation">}</span></mark><br><span class="highlight-line">	<span class="token punctuation">}</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p>What we really don’t want to do next is to just overwrite our highlights files everytime we run the program. Rather, let’s check if the file already contains our highlight text. If so, we return, if not we can then go ahead and append the highlight. We do this by reading in the entire file, turn it into a big string and use <code>strings.Contains</code> to do the check.</p>
<pre class="language-go"><code class="language-go"><span class="highlight-line"><span class="token keyword">func</span> <span class="token function">saveHighlight</span><span class="token punctuation">(</span>highlight HighlightData<span class="token punctuation">,</span> highlightsFolder <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span>highlightsFolder<span class="token punctuation">)</span><span class="token punctuation">;</span> os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">		os<span class="token punctuation">.</span><span class="token function">Mkdir</span><span class="token punctuation">(</span>highlightsFolder<span class="token punctuation">,</span> os<span class="token punctuation">.</span>ModePerm<span class="token punctuation">)</span></span><br><span class="highlight-line">	<span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">	authorFolder <span class="token operator">:=</span> highlightsFolder <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> highlight<span class="token punctuation">.</span>Author</span><br><span class="highlight-line">	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span>authorFolder<span class="token punctuation">)</span><span class="token punctuation">;</span> os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">		os<span class="token punctuation">.</span><span class="token function">Mkdir</span><span class="token punctuation">(</span>authorFolder<span class="token punctuation">,</span> os<span class="token punctuation">.</span>ModePerm<span class="token punctuation">)</span></span><br><span class="highlight-line">	<span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">	bookFile <span class="token operator">:=</span> authorFolder <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> highlight<span class="token punctuation">.</span>Book <span class="token operator">+</span> <span class="token string">".md"</span></span><br><span class="highlight-line">	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span>bookFile<span class="token punctuation">)</span><span class="token punctuation">;</span> os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">		err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span></span><br><span class="highlight-line">            bookFile<span class="token punctuation">,</span> </span><br><span class="highlight-line">            <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"# "</span><span class="token operator">+</span>highlight<span class="token punctuation">.</span>Book<span class="token operator">+</span><span class="token string">"\n## "</span><span class="token operator">+</span>highlight<span class="token punctuation">.</span>Author<span class="token punctuation">)</span><span class="token punctuation">,</span> </span><br><span class="highlight-line">            <span class="token number">0755</span><span class="token punctuation">)</span></span><br><span class="highlight-line">		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">			log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span><br><span class="highlight-line">		<span class="token punctuation">}</span></span><br><span class="highlight-line">	<span class="token punctuation">}</span></span><br><mark class="highlight-line highlight-line-active"></mark><br><mark class="highlight-line highlight-line-active">	fileBytes<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>bookFile<span class="token punctuation">)</span></mark><br><mark class="highlight-line highlight-line-active">	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></mark><br><mark class="highlight-line highlight-line-active">	<span class="token punctuation">}</span></mark><br><mark class="highlight-line highlight-line-active">	fileContent <span class="token operator">:=</span> <span class="token function">string</span><span class="token punctuation">(</span>fileBytes<span class="token punctuation">)</span></mark><br><mark class="highlight-line highlight-line-active">	<span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>fileContent<span class="token punctuation">,</span> highlight<span class="token punctuation">.</span>Text<span class="token punctuation">)</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">		<span class="token keyword">return</span></mark><br><mark class="highlight-line highlight-line-active">	<span class="token punctuation">}</span></mark><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p>After that we can go ahead with appending the highlight metadata and text:</p>
<pre class="language-go"><code class="language-go"><span class="highlight-line"><span class="token keyword">func</span> <span class="token function">saveHighlight</span><span class="token punctuation">(</span>highlight HighlightData<span class="token punctuation">,</span> highlightsFolder <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span>highlightsFolder<span class="token punctuation">)</span><span class="token punctuation">;</span> os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">		os<span class="token punctuation">.</span><span class="token function">Mkdir</span><span class="token punctuation">(</span>highlightsFolder<span class="token punctuation">,</span> os<span class="token punctuation">.</span>ModePerm<span class="token punctuation">)</span></span><br><span class="highlight-line">	<span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">	authorFolder <span class="token operator">:=</span> highlightsFolder <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> highlight<span class="token punctuation">.</span>Author</span><br><span class="highlight-line">	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span>authorFolder<span class="token punctuation">)</span><span class="token punctuation">;</span> os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">		os<span class="token punctuation">.</span><span class="token function">Mkdir</span><span class="token punctuation">(</span>authorFolder<span class="token punctuation">,</span> os<span class="token punctuation">.</span>ModePerm<span class="token punctuation">)</span></span><br><span class="highlight-line">	<span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">	bookFile <span class="token operator">:=</span> authorFolder <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> highlight<span class="token punctuation">.</span>Book <span class="token operator">+</span> <span class="token string">".md"</span></span><br><span class="highlight-line">	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span>bookFile<span class="token punctuation">)</span><span class="token punctuation">;</span> os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">		err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span></span><br><span class="highlight-line">            bookFile<span class="token punctuation">,</span> </span><br><span class="highlight-line">            <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"# "</span><span class="token operator">+</span>highlight<span class="token punctuation">.</span>Book<span class="token operator">+</span><span class="token string">"\n## "</span><span class="token operator">+</span>highlight<span class="token punctuation">.</span>Author<span class="token punctuation">)</span><span class="token punctuation">,</span> </span><br><span class="highlight-line">            <span class="token number">0755</span><span class="token punctuation">)</span></span><br><span class="highlight-line">		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">			log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span><br><span class="highlight-line">		<span class="token punctuation">}</span></span><br><span class="highlight-line">	<span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">	fileBytes<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>bookFile<span class="token punctuation">)</span></span><br><span class="highlight-line">	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span><br><span class="highlight-line">	<span class="token punctuation">}</span></span><br><span class="highlight-line">	fileContent <span class="token operator">:=</span> <span class="token function">string</span><span class="token punctuation">(</span>fileBytes<span class="token punctuation">)</span></span><br><span class="highlight-line">	<span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>fileContent<span class="token punctuation">,</span> highlight<span class="token punctuation">.</span>Text<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">		<span class="token keyword">return</span></span><br><span class="highlight-line">	<span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><mark class="highlight-line highlight-line-active">    file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span>bookFile<span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_APPEND<span class="token operator">|</span>os<span class="token punctuation">.</span>O_WRONLY<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">        log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token punctuation">}</span></mark><br><mark class="highlight-line highlight-line-active"></mark><br><mark class="highlight-line highlight-line-active">    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"\n\n### "</span> <span class="token operator">+</span> highlight<span class="token punctuation">.</span>Timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token punctuation">}</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"\n#### "</span> <span class="token operator">+</span> strings<span class="token punctuation">.</span><span class="token function">Title</span><span class="token punctuation">(</span>highlight<span class="token punctuation">.</span>Location<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token punctuation">}</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"\n\n"</span> <span class="token operator">+</span> highlight<span class="token punctuation">.</span>Text<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></mark><br><mark class="highlight-line highlight-line-active">        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></mark><br><mark class="highlight-line highlight-line-active">    <span class="token punctuation">}</span></mark><br><span class="highlight-line"><span class="token punctuation">}</span></span></code></pre>
<p>With that done, we iterate over all highlights in the <code>main</code> function and pass every highlight into our newly written <code>saveHighlight</code> function, which will write all the contents to the given folder path:</p>
<pre class="language-go"><code class="language-go">    <span class="token comment">// ...</span><br>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> highlight <span class="token operator">:=</span> <span class="token keyword">range</span> highlights <span class="token punctuation">{</span><br>            <span class="token function">saveHighlight</span><span class="token punctuation">(</span>highlight<span class="token punctuation">,</span> <span class="token string">"~/kindle-highlights"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span></code></pre>
<p>An example file with one highlight looks like the following:</p>
<pre><code># The Color of Magic
## Terry David John Pratchett

### Sunday, 14 February 2021 09:24:24
#### Location 2-3

The Colour of Magic is Terry Pratchett’s maiden voyage through the bizarre land of Discworld.
</code></pre>
<p>The only thing missing is to allow passing a destination folder parameter to the main function so that we can conveniently use it as a command line tool without having to always edit the filepath in the source code. We can easily access the raw command-line arguments using <code>os.Args</code>, which is of type <code>slice</code>. Its first value is the program path. So if we want to call our program using <code>go run main.go &quot;~/kindle-highlights&quot;</code> (or <code>programName &quot;~/kindle-highlights&quot;</code> when compiled), we can access the path with <code>os.Args[1]</code>:</p>
<pre class="language-go"><code class="language-go"><span class="highlight-line">    <span class="token comment">// ...</span></span><br><span class="highlight-line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> highlight <span class="token operator">:=</span> <span class="token keyword">range</span> highlights <span class="token punctuation">{</span></span><br><mark class="highlight-line highlight-line-active">		<span class="token function">saveHighlight</span><span class="token punctuation">(</span>highlight<span class="token punctuation">,</span> os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span></mark><br><span class="highlight-line">	<span class="token punctuation">}</span></span><br><span class="highlight-line"></span></code></pre>
<p>Awesome! That’s it. Compile it and run it whenever you want to sync your highlights. Or write some code to automate running the script whenever a USB device mounts!</p>
<h2 id="all-the-code">All the code <a class="direct-link" href="#all-the-code">#</a></h2>
<pre class="language-go"><code class="language-go"><span class="token keyword">package</span> main<br><br><span class="token keyword">import</span> <span class="token punctuation">(</span><br>	<span class="token string">"bufio"</span><br>	<span class="token string">"io/ioutil"</span><br>	<span class="token string">"log"</span><br>	<span class="token string">"os"</span><br>	<span class="token string">"regexp"</span><br>	<span class="token string">"strings"</span><br><span class="token punctuation">)</span><br><br><span class="token keyword">const</span> separator <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">"=========="</span><br><br><span class="token keyword">type</span> HighlightData <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>	author    <span class="token builtin">string</span><br>	book      <span class="token builtin">string</span><br>	timestamp <span class="token builtin">string</span><br>	location  <span class="token builtin">string</span><br>	text      <span class="token builtin">string</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">parseAuthorTitle</span><span class="token punctuation">(</span>line <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	splitLines <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">"("</span><span class="token punctuation">)</span><br>	bookRaw <span class="token operator">:=</span> splitLines<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><br>	authorRaw <span class="token operator">:=</span> splitLines<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><br><br>	book <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">TrimSpace</span><span class="token punctuation">(</span>bookRaw<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span><br>	author <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Trim</span><span class="token punctuation">(</span>authorRaw<span class="token punctuation">,</span> <span class="token string">")"</span><span class="token punctuation">)</span><br>	<span class="token keyword">return</span> author<span class="token punctuation">,</span> book<br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">parseLocDatetime</span><span class="token punctuation">(</span>line <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	header <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">" | "</span><span class="token punctuation">)</span><br>	locRaw <span class="token operator">:=</span> header<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><br>	re <span class="token operator">:=</span> regexp<span class="token punctuation">.</span><span class="token function">MustCompile</span><span class="token punctuation">(</span><span class="token string">`location [\d]+-[\d]+`</span><span class="token punctuation">)</span><br>	location <span class="token operator">:=</span> re<span class="token punctuation">.</span><span class="token function">FindString</span><span class="token punctuation">(</span>locRaw<span class="token punctuation">)</span><br><br>	dateRaw <span class="token operator">:=</span> header<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><br>	timestamp <span class="token operator">:=</span> dateRaw<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">:</span><span class="token punctuation">]</span><br>	<span class="token keyword">return</span> location<span class="token punctuation">,</span> timestamp<br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">saveHighlight</span><span class="token punctuation">(</span>highlight HighlightData<span class="token punctuation">,</span> highlightsFolder <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span>highlightsFolder<span class="token punctuation">)</span><span class="token punctuation">;</span> os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		os<span class="token punctuation">.</span><span class="token function">Mkdir</span><span class="token punctuation">(</span>highlightsFolder<span class="token punctuation">,</span> os<span class="token punctuation">.</span>ModePerm<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><br>	authorFolder <span class="token operator">:=</span> highlightsFolder <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> highlight<span class="token punctuation">.</span>Author<br>	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span>authorFolder<span class="token punctuation">)</span><span class="token punctuation">;</span> os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		os<span class="token punctuation">.</span><span class="token function">Mkdir</span><span class="token punctuation">(</span>authorFolder<span class="token punctuation">,</span> os<span class="token punctuation">.</span>ModePerm<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><br>	bookFile <span class="token operator">:=</span> authorFolder <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> highlight<span class="token punctuation">.</span>Book <span class="token operator">+</span> <span class="token string">".md"</span><br>	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span>bookFile<span class="token punctuation">)</span><span class="token punctuation">;</span> os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span><br>			bookFile<span class="token punctuation">,</span><br>			<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"# "</span><span class="token operator">+</span>highlight<span class="token punctuation">.</span>Book<span class="token operator">+</span><span class="token string">"\n## "</span><span class="token operator">+</span>highlight<span class="token punctuation">.</span>Author<span class="token punctuation">)</span><span class="token punctuation">,</span><br>			<span class="token number">0755</span><span class="token punctuation">)</span><br>		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>			log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><br>		<span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><br><br>	fileBytes<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>bookFile<span class="token punctuation">)</span><br>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br>	fileContent <span class="token operator">:=</span> <span class="token function">string</span><span class="token punctuation">(</span>fileBytes<span class="token punctuation">)</span><br>	<span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>fileContent<span class="token punctuation">,</span> highlight<span class="token punctuation">.</span>Text<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">return</span><br>	<span class="token punctuation">}</span><br><br>	file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span>bookFile<span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_APPEND<span class="token operator">|</span>os<span class="token punctuation">.</span>O_WRONLY<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><br>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><br>	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"\n\n### "</span> <span class="token operator">+</span> highlight<span class="token punctuation">.</span>Timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br>	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"\n#### "</span> <span class="token operator">+</span> strings<span class="token punctuation">.</span><span class="token function">Title</span><span class="token punctuation">(</span>highlight<span class="token punctuation">.</span>Location<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br>	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"\n\n"</span> <span class="token operator">+</span> highlight<span class="token punctuation">.</span>Text<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><br>	file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"/Volumes/Kindle/documents/My Clippings.txt"</span><span class="token punctuation">)</span><br>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><br>	scanner <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewScanner</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><br><br>	scanner<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>bufio<span class="token punctuation">.</span>ScanLines<span class="token punctuation">)</span><br><br>	<span class="token keyword">var</span> counter <span class="token builtin">int</span><br><br>	<span class="token keyword">var</span> highlights <span class="token punctuation">[</span><span class="token punctuation">]</span>HighlightData<br>	<span class="token keyword">var</span> hl HighlightData <span class="token operator">=</span> HighlightData<span class="token punctuation">{</span><span class="token punctuation">}</span><br>	<span class="token keyword">for</span> scanner<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		line <span class="token operator">:=</span> scanner<span class="token punctuation">.</span><span class="token function">Text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>		<span class="token keyword">if</span> counter <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span><br>			hl<span class="token punctuation">.</span>author<span class="token punctuation">,</span> hl<span class="token punctuation">.</span>book <span class="token operator">=</span> <span class="token function">parseAuthorTitle</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><br>		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> counter <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span><br>			hl<span class="token punctuation">.</span>location<span class="token punctuation">,</span> hl<span class="token punctuation">.</span>timestamp <span class="token operator">=</span> <span class="token function">parseLocDatetime</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><br>		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>			<span class="token keyword">if</span> line <span class="token operator">==</span> separator <span class="token punctuation">{</span><br>				highlights <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>highlights<span class="token punctuation">,</span> hl<span class="token punctuation">)</span><br>				hl <span class="token operator">=</span> HighlightData<span class="token punctuation">{</span><span class="token punctuation">}</span><br>				counter <span class="token operator">=</span> <span class="token number">0</span><br>				<span class="token keyword">continue</span><br>			<span class="token punctuation">}</span><br>			hl<span class="token punctuation">.</span>text <span class="token operator">=</span> hl<span class="token punctuation">.</span>text <span class="token operator">+</span> line<br>		<span class="token punctuation">}</span><br>		counter<span class="token operator">++</span><br>	<span class="token punctuation">}</span><br><br>	file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> highlight <span class="token operator">:=</span> <span class="token keyword">range</span> highlights <span class="token punctuation">{</span><br>		<span class="token function">saveHighlight</span><span class="token punctuation">(</span>highlight<span class="token punctuation">,</span> os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>

  </div>
</div>
  </main>
  <footer style="min-height: 4em;"></footer>
</body>

</html>